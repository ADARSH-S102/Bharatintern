import pandas as pd
import gradio as gr
import os

def get_match_keys(df, filename):
    match_keys = []
    
    if "ALGO" in filename.upper():
        if 'Agreement_name' not in df.columns:
            raise ValueError("Missing 'Agreement_name' column in ALGO file.")
        for val in df['Agreement_name']:
            key = val.replace('_RIMR', '3CR').replace('_RIMP', '3CP')
            match_keys.append(key)
    
    elif "STAR" in filename.upper():
        required_cols = ['CRDS Party Code', 'Post Direction']
        if not all(col in df.columns for col in required_cols):
            raise ValueError("Missing required columns in STAR file.")
        for i, row in df.iterrows():
            key = str(row['CRDS Party Code']) + '3' + str(row['Post Direction'])
            match_keys.append(key)
    
    else:
        raise ValueError("Unable to determine file type from filename. Please include 'ALGO' or 'STAR' in filename.")
    
    return match_keys

def reconcile_csv_files(file1, file2):
    try:
        # Load files
        df1 = pd.read_csv(file1).astype(str)
        df2 = pd.read_csv(file2).astype(str)

        # Get filenames
        filename1 = os.path.basename(file1.name)
        filename2 = os.path.basename(file2.name)

        # Extract match keys
        keys1 = get_match_keys(df1, filename1)
        keys2 = get_match_keys(df2, filename2)

        results = []
        max_len = max(len(keys1), len(keys2))

        for i in range(max_len):
            k1 = keys1[i] if i < len(keys1) else "<Missing>"
            k2 = keys2[i] if i < len(keys2) else "<Missing>"

            if k1 == k2:
                results.append(f"Row {i+1}: Match ({k1})")
            else:
                results.append(f"Row {i+1}: Mismatch\n  ALGO: {k1}\n  STAR: {k2}\n")

        return "\n".join(results)

    except Exception as e:
        return f"Error: {str(e)}"

# Gradio UI
iface = gr.Interface(
    fn=reconcile_csv_files,
    inputs=[
        gr.File(label="Upload ALGO CSV (filename must contain 'ALGO')"),
        gr.File(label="Upload STAR CSV (filename must contain 'STAR')")
    ],
    outputs="text",
    title="CSV Reconciliation - Custom Match Rule",
    description="Compares ALGO and STAR CSV files using custom matching logic based on file type and key transformation."
)

if __name__ == "__main__":
    iface.launch()
